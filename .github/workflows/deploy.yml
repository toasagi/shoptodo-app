name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get existing gh-pages content
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-existing
        continue-on-error: true

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          # Copy app files (exclude development files)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='e2e' --exclude='.github' --exclude='tests' --exclude='coverage' --exclude='allure-results' --exclude='deploy' --exclude='gh-pages-existing' . deploy/
          # Keep existing Allure report if it exists
          if [ -d "gh-pages-existing/allure" ]; then
            cp -r gh-pages-existing/allure deploy/
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: deploy
          publish_branch: gh-pages

      - name: Create deployment summary
        run: |
          echo "# ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://toasagi.github.io/shoptodo-app/" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: Push to main branch" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… The application is now live and accessible to everyone for E2E testing practice!" >> $GITHUB_STEP_SUMMARY